<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo - DOM Renderer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e293b;
      min-height: 100vh;
    }
    
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1e293b;
      color: white;
      z-index: 10000;
    }
    
    #loading.hidden {
      display: none;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #error {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #1e293b;
      color: white;
      padding: 24px;
      text-align: center;
    }
    
    #error.visible {
      display: flex;
    }
    
    #error-icon {
      width: 64px;
      height: 64px;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      font-size: 32px;
    }
    
    #error h2 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    
    #error p {
      color: #94a3b8;
      font-size: 14px;
      max-width: 400px;
    }
    
    #content-frame {
      width: 100%;
      min-height: 100vh;
      border: none;
      background: white;
    }
    
    /* Overlay for comment pins */
    #pins-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }
    
    .comment-pin {
      position: absolute;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 2px solid white;
      transform: translate(-50%, -50%);
      transition: all 0.2s ease;
    }
    
    .comment-pin:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 10000;
    }
    
    .comment-pin.resolved {
      background: linear-gradient(135deg, #10B981, #059669);
    }
    
    /* Info banner */
    #info-banner {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 10001;
      color: white;
      font-size: 13px;
    }
    
    #info-banner.hidden {
      display: none;
    }
    
    #info-banner .icon {
      width: 32px;
      height: 32px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    #info-banner .text {
      flex: 1;
    }
    
    #info-banner .text strong {
      display: block;
      margin-bottom: 2px;
    }
    
    #info-banner .text span {
      color: #94a3b8;
      font-size: 12px;
    }
    
    #close-banner {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
    }
    
    #close-banner:hover {
      color: white;
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>Loading captured page...</p>
  </div>
  
  <div id="error">
    <div id="error-icon">‚ö†Ô∏è</div>
    <h2>Unable to Load Page</h2>
    <p id="error-message">The captured DOM could not be rendered. Please try viewing the screenshot instead.</p>
  </div>
  
  <iframe id="content-frame" sandbox="allow-same-origin"></iframe>
  
  <div id="pins-overlay"></div>
  
  <div id="info-banner">
    <div class="icon">üìÑ</div>
    <div class="text">
      <strong>DOM Snapshot View</strong>
      <span>This is a captured snapshot of the page. Some interactive elements may not work.</span>
    </div>
    <button id="close-banner" onclick="this.parentElement.classList.add('hidden')">√ó</button>
  </div>

  <script>
    // DOM Renderer - Displays captured HTML snapshots
    
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('error-message');
    const frame = document.getElementById('content-frame');
    const pinsOverlay = document.getElementById('pins-overlay');
    
    // Get data from parent window or URL params
    let htmlSnapshot = null;
    let commentPins = [];
    
    // Listen for messages from parent (dashboard)
    window.addEventListener('message', (event) => {
      if (event.data.type === 'RENDER_DOM') {
        htmlSnapshot = event.data.htmlSnapshot;
        commentPins = event.data.pins || [];
        renderSnapshot();
      }
      
      if (event.data.type === 'UPDATE_PINS') {
        commentPins = event.data.pins || [];
        renderPins();
      }
    });
    
    // Also check URL params for direct access
    const urlParams = new URLSearchParams(window.location.search);
    const snapshotId = urlParams.get('snapshot');
    
    if (snapshotId) {
      // Fetch snapshot from API
      fetchSnapshot(snapshotId);
    }
    
    async function fetchSnapshot(id) {
      try {
        // This would fetch from your Supabase storage
        // For now, show error
        showError('Direct snapshot loading not yet implemented. Please access via dashboard.');
      } catch (e) {
        showError('Failed to load snapshot: ' + e.message);
      }
    }
    
    function renderSnapshot() {
      if (!htmlSnapshot) {
        showError('No HTML snapshot provided.');
        return;
      }
      
      try {
        // Get the HTML content
        let html = htmlSnapshot.html || htmlSnapshot;
        
        // If it's an object with html property
        if (typeof htmlSnapshot === 'object' && htmlSnapshot.html) {
          html = htmlSnapshot.html;
        }
        
        // Inject additional styles to make it look right
        const additionalStyles = `
          <style>
            /* Disable all links and forms in snapshot */
            a { pointer-events: none !important; }
            form { pointer-events: none !important; }
            button { pointer-events: none !important; }
            input { pointer-events: none !important; }
            select { pointer-events: none !important; }
            textarea { pointer-events: none !important; }
            
            /* Show visual indicator for disabled elements */
            a:hover, button:hover {
              cursor: not-allowed !important;
            }
          </style>
        `;
        
        // Inject styles before closing head tag
        if (html.includes('</head>')) {
          html = html.replace('</head>', additionalStyles + '</head>');
        } else {
          html = additionalStyles + html;
        }
        
        // Write to iframe
        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open();
        doc.write(html);
        doc.close();
        
        // Hide loading
        loading.classList.add('hidden');
        
        // Render comment pins
        renderPins();
        
        // Notify parent that rendering is complete
        window.parent.postMessage({ type: 'DOM_RENDERED', success: true }, '*');
        
      } catch (e) {
        console.error('Error rendering snapshot:', e);
        showError('Failed to render page: ' + e.message);
      }
    }
    
    function renderPins() {
      pinsOverlay.innerHTML = '';
      
      commentPins.forEach(pin => {
        const pinEl = document.createElement('div');
        pinEl.className = `comment-pin ${pin.resolved ? 'resolved' : ''}`;
        pinEl.style.left = `${pin.x}px`;
        pinEl.style.top = `${pin.y}px`;
        pinEl.textContent = pin.count || '1';
        pinEl.title = `${pin.count || 1} comment${(pin.count || 1) !== 1 ? 's' : ''} - Click to view`;
        
        pinEl.addEventListener('click', () => {
          // Notify parent to show thread
          window.parent.postMessage({
            type: 'PIN_CLICKED',
            threadId: pin.threadId
          }, '*');
        });
        
        pinsOverlay.appendChild(pinEl);
      });
    }
    
    function showError(message) {
      loading.classList.add('hidden');
      errorMessage.textContent = message;
      error.classList.add('visible');
      
      // Notify parent of error
      window.parent.postMessage({ type: 'DOM_RENDER_ERROR', error: message }, '*');
    }
    
    // If no message received within 5 seconds, show timeout error
    setTimeout(() => {
      if (!htmlSnapshot && !loading.classList.contains('hidden')) {
        showError('Timeout waiting for DOM snapshot. The page may not have been captured.');
      }
    }, 5000);
  </script>
</body>
</html>

